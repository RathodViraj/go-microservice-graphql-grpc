name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      account: ${{ steps.filter.outputs.account }}
      catalog: ${{ steps.filter.outputs.catalog }}
      order: ${{ steps.filter.outputs.order }}
      inventory: ${{ steps.filter.outputs.inventory }}
      common: ${{ steps.filter.outputs.common }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            account:
              - 'account/**'
            catalog:
              - 'catalog/**'
            order:
              - 'order/**'
            inventory:
              - 'inventory/**'
            common:
              - 'go.mod'
              - 'go.sum'
              - '.github/workflows/**'

  test-account:
    needs: changes
    if: ${{ needs.changes.outputs.account == 'true' || needs.changes.outputs.common == 'true' }}
    runs-on: ubuntu-latest

    services:
      account_db:
        image: postgres:16
        env:
          POSTGRES_USER: viraj
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: account_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U viraj"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL_FOR_TEST: postgres://viraj:123456@localhost:5432/account_test?sslmode=disable

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Wait for Postgres
        run: |
          until pg_isready -h localhost -p 5432 -U viraj; do
            echo "Waiting for DB..."
            sleep 2
          done

      - name: Apply schema
        run: |
          psql "$DATABASE_URL_FOR_TEST" -f account/up.sql

      - name: Run account tests
        run: go test ./account/... -v

  test-catalog:
    needs: changes
    if: ${{ needs.changes.outputs.catalog == 'true' || needs.changes.outputs.common == 'true' }}
    runs-on: ubuntu-latest

    services:
      catalog_db:
        image: elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
  
    env:
      ELASTICSEARCH_URL_FOR_TEST: http://localhost:9200

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Wait for Elasticsearch
        run: |
          until curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do
            echo "Waiting for Elasticsearch..."
            sleep 2
          done

      - name: Run catalog tests
        run: go test ./catalog/... -v
  
  test-inventory:
    needs: changes
    if: ${{ needs.changes.outputs.inventory == 'true' || needs.changes.outputs.common == 'true' }}
    runs-on: ubuntu-latest

    services:
      inventory_db:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      REDIS_URL_FOR_TEST: redis://localhost:6379

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
        
      - name: Wait for Redis
        run: |
          until redis-cli -h localhost -p 6379 ping | grep -q PONG; do
            echo "Waiting for Redis..."
            sleep 2
          done
        
      - name: Run inventory tests
        run: go test ./inventory/... -v

  test-order:
    needs: changes
    if: ${{ needs.changes.outputs.order == 'true' || needs.changes.outputs.catalog == 'true' || needs.changes.outputs.account == 'true' || needs.changes.outputs.common == 'true' }}
    runs-on: ubuntu-latest

    services:
      order_db:
        image: postgres:16
        env:
          POSTGRES_USER: viraj
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: order_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd="pg_isready -U viraj"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      account_db:
        image: postgres:16
        env:
          POSTGRES_USER: viraj
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: account_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U viraj"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      catalog_es:
        image: elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DATABASE_URL_FOR_TEST: postgres://viraj:123456@localhost:5433/order_test?sslmode=disable
      ACCOUNT_DATABASE_URL_FOR_TEST: postgres://viraj:123456@localhost:5432/account_test?sslmode=disable
      ELASTICSEARCH_URL_FOR_TEST: http://localhost:9200

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Wait for Postgres (order)
        run: |
          until pg_isready -h localhost -p 5433 -U viraj; do
            echo "Waiting for order DB..."
            sleep 2
          done

      - name: Wait for Postgres (account)
        run: |
          until pg_isready -h localhost -p 5432 -U viraj; do
            echo "Waiting for account DB..."
            sleep 2
          done

      - name: Wait for Elasticsearch
        run: |
          until curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do
            echo "Waiting for Elasticsearch..."
            sleep 2
          done

      - name: Apply order schema
        run: |
          psql "$DATABASE_URL_FOR_TEST" -f order/up.sql

      - name: Apply account schema
        run: |
          psql "postgres://viraj:123456@localhost:5432/account_test?sslmode=disable" -f account/up.sql

      - name: Run order tests
        run: go test ./order/... -v